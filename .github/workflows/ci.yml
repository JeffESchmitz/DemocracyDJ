name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Toggle verbose logging: 'true' for debug output, 'false' for quiet builds
  VERBOSE_BUILD: 'false'

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      ios: ${{ steps.filter.outputs.ios }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'web/**'
            ios:
              - 'ios/**'
            shared:
              - 'shared/**'

  build-ios:
    name: Build iOS
    runs-on: macos-26
    timeout-minutes: 30
    needs: changes
    if: needs.changes.outputs.ios == 'true' || needs.changes.outputs.shared == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 26.2
        run: |
          sudo xcode-select -s /Applications/Xcode_26.2.app
          xcodebuild -version

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/DemocracyDJ-*/SourcePackages
            ios/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('ios/DemocracyDJ.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install iOS Simulator Runtime
        run: xcodebuild -downloadPlatform iOS

      - name: Build iOS app (for testing)
        working-directory: ios
        run: |
          QUIET_FLAG=""
          if [ "$VERBOSE_BUILD" != "true" ]; then
            QUIET_FLAG="-quiet"
          fi
          xcodebuild $QUIET_FLAG \
            -project DemocracyDJ.xcodeproj \
            -scheme DemocracyDJ \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17' \
            -skipMacroValidation \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            build-for-testing

      - name: Run iOS unit tests
        working-directory: ios
        run: |
          QUIET_FLAG=""
          if [ "$VERBOSE_BUILD" != "true" ]; then
            QUIET_FLAG="-quiet"
          fi
          xcodebuild $QUIET_FLAG \
            -project DemocracyDJ.xcodeproj \
            -scheme DemocracyDJ \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17' \
            -skipMacroValidation \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            test-without-building

      - name: Run iOS UI tests (non-blocking)
        working-directory: ios
        run: |
          UI_TEST_TARGET=$(xcodebuild -list -project DemocracyDJ.xcodeproj 2>/dev/null | grep -m1 "UITests" | sed -E 's/^[[:space:]]*//' || true)
          if [ -n "$UI_TEST_TARGET" ]; then
            echo "Found UI test target: $UI_TEST_TARGET"
            QUIET_FLAG=""
            if [ "$VERBOSE_BUILD" != "true" ]; then
              QUIET_FLAG="-quiet"
            fi
            xcodebuild $QUIET_FLAG \
              -project DemocracyDJ.xcodeproj \
              -scheme DemocracyDJ \
              -sdk iphonesimulator \
              -destination 'platform=iOS Simulator,name=iPhone 17' \
              -skipMacroValidation \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              -only-testing:"$UI_TEST_TARGET" \
              test || true
          else
            echo "No UI test target found; skipping UI tests."
          fi

  test-shared:
    name: Test Shared Package
    runs-on: macos-26
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.shared == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 26.2
        run: |
          sudo xcode-select -s /Applications/Xcode_26.2.app
          xcodebuild -version

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            shared/.build
          key: ${{ runner.os }}-spm-shared-${{ hashFiles('shared/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-shared-

      - name: Run Swift tests
        run: |
          if [ "$VERBOSE_BUILD" != "true" ]; then
            LOG_FILE=$(mktemp)
            swift test --package-path shared 2>&1 | tee "$LOG_FILE"
            TEST_STATUS=${PIPESTATUS[0]}
            grep -E "(Test|error|warning|passed|failed|Build complete)" "$LOG_FILE" || true
            exit "$TEST_STATUS"
          else
            swift test --package-path shared
          fi

  lint-web:
    name: Lint Web
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Lint
        working-directory: web
        run: npm run lint

      - name: Type check
        working-directory: web
        run: npx tsc --noEmit
