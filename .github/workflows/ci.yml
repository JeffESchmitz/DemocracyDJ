name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      verbose:
        description: "Enable verbose logs"
        required: false
        default: "true"
      force_ios:
        description: "Force Build iOS to run"
        required: false
        default: "true"
      force_shared:
        description: "Force Test Shared Package to run"
        required: false
        default: "false"
      force_web:
        description: "Force Lint Web to run"
        required: false
        default: "false"
      disable_spm_cache:
        description: "Disable SPM dependency caching (fixes macro issues)"
        required: false
        default: "false"
      disable_ios:
        description: "Skip Build iOS job entirely"
        required: false
        default: "false"

env:
  # Toggle verbose logging: 'true' for debug output, 'false' for quiet builds
  VERBOSE_BUILD: ${{ inputs.verbose || 'false' }}

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      ios: ${{ steps.filter.outputs.ios }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'web/**'
            ios:
              - 'ios/**'
            shared:
              - 'shared/**'

  build-ios:
    name: Build iOS
    runs-on: macos-26
    timeout-minutes: 30
    needs: changes
    if: (needs.changes.outputs.ios == 'true' || needs.changes.outputs.shared == 'true' || inputs.force_ios == 'true') && inputs.disable_ios != 'true'
    env:
      DERIVED_DATA_PATH: ~/Library/Developer/Xcode/DerivedData/DemocracyDJ-CI
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 26.2
        run: |
          sudo xcode-select -s /Applications/Xcode_26.2.app
          xcodebuild -version
          echo "XCODE_VERSION=$(xcodebuild -version | head -n1 | awk '{print $2}')" >> "$GITHUB_ENV"

      - name: Cache SPM dependencies
        if: inputs.disable_spm_cache != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.DERIVED_DATA_PATH }}/SourcePackages
            ios/.build
            ~/.swiftpm
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('ios/DemocracyDJ.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install iOS Simulator Runtime
        run: |
          xcodebuild -downloadPlatform iOS || {
            echo "Retrying simulator runtime download..."
            sleep 10
            xcodebuild -downloadPlatform iOS
          }

      - name: Pre-boot Simulator
        run: |
          xcrun simctl boot "iPhone 17" || true

      - name: Build and Test iOS
        working-directory: ios
        run: |
          QUIET_FLAG=""
          if [ "$VERBOSE_BUILD" != "true" ]; then
            QUIET_FLAG="-quiet"
          fi
          xcodebuild test $QUIET_FLAG \
            -project DemocracyDJ.xcodeproj \
            -scheme DemocracyDJ \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17' \
            -disable-concurrent-destination-testing \
            -showBuildTimingSummary \
            -skipMacroValidation \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

  test-shared:
    name: Test Shared Package
    runs-on: macos-26
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.shared == 'true' || inputs.force_shared == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 26.2
        run: |
          sudo xcode-select -s /Applications/Xcode_26.2.app
          xcodebuild -version

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            shared/.build
          key: ${{ runner.os }}-spm-shared-${{ hashFiles('shared/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-shared-

      - name: Run Swift tests
        run: |
          if [ "$VERBOSE_BUILD" != "true" ]; then
            LOG_FILE=$(mktemp)
            swift test --package-path shared 2>&1 | tee "$LOG_FILE"
            TEST_STATUS=${PIPESTATUS[0]}
            grep -E "(Test|error|warning|passed|failed|Build complete)" "$LOG_FILE" || true
            exit "$TEST_STATUS"
          else
            swift test --package-path shared
          fi

  lint-web:
    name: Lint Web
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web == 'true' || inputs.force_web == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Lint
        working-directory: web
        run: npm run lint

      - name: Type check
        working-directory: web
        run: npx tsc --noEmit
